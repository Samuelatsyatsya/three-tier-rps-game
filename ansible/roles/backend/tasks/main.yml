---
- name: Debug configuration
  debug:
    msg:
      - "DB Secret Name: {{ db_secret_name }}"
      - "AWS Region: {{ aws_region }}"
      - "Backend Image: {{ backend_image }}"

- name: Install unzip (required for AWS CLI)
  apt:
    name: unzip
    state: present
    update_cache: yes
  become: yes

- name: Check if AWS CLI is installed
  command: aws --version
  register: aws_cli_check
  ignore_errors: yes
  changed_when: false

- name: Install AWS CLI v2
  shell: |
    cd /tmp
    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    unzip -o awscliv2.zip
    ./aws/install --update
    rm -rf awscliv2.zip aws
  become: yes
  when: aws_cli_check.rc != 0

- name: Fetch database credentials from AWS Secrets Manager
  shell: |
    aws secretsmanager get-secret-value \
      --secret-id "{{ db_secret_name }}" \
      --region "{{ aws_region }}" \
      --query SecretString \
      --output text
  register: db_secret_json
  no_log: true

- name: Parse database credentials
  set_fact:
    db_secrets_parsed: "{{ db_secret_json.stdout | from_json }}"
  no_log: true

- name: Set DB credentials as facts
  set_fact:
    db_username: "{{ db_secrets_parsed.username }}"
    db_password: "{{ db_secrets_parsed.password }}"
    db_host: "{{ db_secrets_parsed.host }}"
    db_name: "{{ db_secrets_parsed.dbname }}"
    db_port: "{{ db_secrets_parsed.port }}"
  no_log: true

- name: Create app directory
  file:
    path: /home/ubuntu/app
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Template docker-compose.yml for backend
  template:
    src: docker-compose.yml.j2
    dest: /home/ubuntu/app/docker-compose.yml
    owner: ubuntu
    group: ubuntu
    mode: '0644'

- name: Deploy backend container
  community.docker.docker_compose_v2:
    project_src: /home/ubuntu/app
    restarted: true
    remove_orphans: true
